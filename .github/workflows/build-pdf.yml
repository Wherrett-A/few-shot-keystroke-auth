name: Build Dissertation PDF

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        persist-credentials: true

    - name: Build PDF using Pandoc
      run: |
        mapfile -d '' FILES < <(find dissertation/chapters -name "*.md" -print0 | sort -zV)
        printf "%s\n" "${FILES[@]}"
        docker run --rm -v "$PWD":/data pandoc/latex:3.8 \
          --pdf-engine=xelatex \
          --citeproc \
          --bibliography=dissertation/references.bib \
          --csl=dissertation/harvard-leeds-beckett-university.csl \
          --metadata=link-citations:true \
          --output=dissertation/main.pdf \
          "${FILES[@]}"

    - name: Upload PDF Artifact
      uses: actions/upload-artifact@v5
      with:
        name: Dissertation PDF
        path: dissertation/main.pdf
        
    - name: Commit and Push PDF
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        if [[ -n $(git status --porcelain dissertation/main.pdf) ]]; then
          echo "PDF has changed. Committing and pushing..."
          git add dissertation/main.pdf
          # Keep [skip ci] as the primary method
          git commit -m "Auto-build: Update dissertation PDF [skip ci]"
          git push
        else
          echo "PDF has not changed. No commit needed."
        fi
